{% extends 'users/base.html' %}
{% load static %} {# Load static if you use custom CSS/JS later #}

{% block title %}Identify Ingredients from Photo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6"> {# Limit width for better readability #}

            <h1 class="mb-3 text-center display-5">Identify Ingredients</h1>
            <p class="lead text-center mb-4">Upload a picture of your ingredients, and we'll try to identify them.</p>

            {# Error Message Area #}
            {% if error_message %}
                <div class="alert alert-danger" role="alert">
                    <strong>Error:</strong> {{ error_message }}
                </div>
            {% endif %}

             {# Form Validation Errors (Non-field specific) #}
             {% if form.non_field_errors %}
                 <div class="alert alert-danger" role="alert">
                     {% for error in form.non_field_errors %}
                         {{ error }}<br>
                     {% endfor %}
                 </div>
             {% endif %}

            {# Upload Form Card #}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Upload Your Photo</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" action="{% url 'ai_module:identify_ingredients' %}">
                        {% csrf_token %}

                        {# Render the form field(s) manually for better control #}
                        {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {{ field }} {# Assumes widget has 'form-control' class added in forms.py #}
                            {% if field.help_text %}
                                <div id="{{ field.id_for_label }}_help" class="form-text text-muted">{{ field.help_text }}</div>
                            {% endif %}
                            {% if field.errors %}
                                <div class="invalid-feedback d-block"> {# Use d-block to show errors #}
                                    {% for error in field.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <div class="d-grid"> {# Make button full width within card body #}
                            <button type="submit" class="btn btn-primary btn-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up-fill me-2" viewBox="0 0 16 16">
                                  <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2m2.354 5.146a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0z"/>
                                </svg>
                                Upload and Identify
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {# Results Section #}
            {% if identified_ingredients is not None %}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                     <h5 class="mb-0">Identified Ingredients</h5>
                </div>
                <div class="card-body">
                    {% if identified_ingredients %}
                        <p>We found the following ingredients:</p>
                        <ul class="list-group list-group-flush mb-3">
                            {% for ingredient in identified_ingredients %}
                                <li class="list-group-item">{{ ingredient|capfirst }}</li>
                            {% endfor %}
                        </ul>

                        {# "Find Recipes" Button Form #}
                        <form action="{% url 'ai_module:suggest_recipes' %}" method="post" class="d-grid">
                             {% csrf_token %}
                             {# Join list items into a comma-separated string for the hidden input #}
                             <input type="hidden" name="ingredients" value="{{ identified_ingredients|join:',' }}">
                             <button type="submit" class="btn btn-success">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search me-2" viewBox="0 0 16 16">
                                   <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                                 </svg>
                                 Find Recipes with These Ingredients
                            </button>
                        </form>
                    {% else %}
                         <div class="alert alert-warning mb-0" role="alert">
                             Could not identify any specific ingredients. Please try a clearer picture or ensure ingredients are distinct.
                         </div>
                    {% endif %}
                </div>
            </div>
            {% endif %} {# End check for identified_ingredients existence #}

        </div> {# End col #}
    </div> {# End row #}
</div> {# End container #}
{% endblock %}